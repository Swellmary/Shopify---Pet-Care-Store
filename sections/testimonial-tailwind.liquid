{%- liquid
  # Pre-calculate values for performance
  assign heading = section.settings.heading | escape
  assign blocks = section.blocks
  assign blocks_count = blocks.size
  assign show_images = section.settings.show_images
  assign show_ratings = section.settings.show_ratings
-%}

{% if blocks_count > 0 %}
  <section 
    class="testimonials py-12 px-5 text-center bg-{{ section.settings.color_scheme }}"
    role="region" 
    aria-labelledby="testimonials-heading-{{ section.id }}"
  >
    <!-- Heading with proper ID for accessibility -->
    <h2 
      id="testimonials-heading-{{ section.id }}" 
      class="text-2xl md:text-3xl font-bold mb-10 text-gray-900"
    >
      {{ heading }}
    </h2>
    
    <!-- Testimonial Grid -->
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-{{ section.settings.columns_desktop }} gap-6 max-w-6xl mx-auto">
      
      {% for block in blocks %}
        {%- liquid
          assign quote = block.settings.quote | escape | newline_to_br
          assign author = block.settings.author | escape
          assign author_title = block.settings.author_title | escape
          assign rating = block.settings.rating | default: 5
          assign image = block.settings.image
          assign link = block.settings.link
        -%}
        
        <figure 
          class="testimonial-card flex flex-col p-6 border border-gray-200 rounded-xl bg-white shadow-md hover:shadow-xl transition-all duration-300 ease-out hover:-translate-y-1"
          {{ block.shopify_attributes }}
        >
          
          <!-- Star Rating (Optional) -->
          {% if show_ratings %}
            <div class="flex justify-center mb-4" aria-label="Rating: {{ rating }} out of 5 stars">
              {% for i in (1..5) %}
                {% if i <= rating %}
                  <svg class="w-5 h-5 text-yellow-400 fill-current" viewBox="0 0 20 20" aria-hidden="true">
                    <path d="M10 15l-5.878 3.09 1.123-6.545L.489 6.91l6.572-.955L10 0l2.939 5.955 6.572.955-4.756 4.635 1.123 6.545z"/>
                  </svg>
                {% else %}
                  <svg class="w-5 h-5 text-gray-300 fill-current" viewBox="0 0 20 20" aria-hidden="true">
                    <path d="M10 15l-5.878 3.09 1.123-6.545L.489 6.91l6.572-.955L10 0l2.939 5.955 6.572.955-4.756 4.635 1.123 6.545z"/>
                  </svg>
                {% endif %}
              {% endfor %}
            </div>
          {% endif %}
          
          <!-- Quote -->
          <blockquote class="flex-grow italic text-base md:text-lg leading-relaxed text-gray-700 mb-6">
            <p>"{{ quote }}"</p>
          </blockquote>
          
          <!-- Author Section -->
          <figcaption class="flex items-center justify-center gap-4 mt-auto">
            
            <!-- Author Image (Optional) -->
            {% if show_images and image != blank %}
              <div class="flex-shrink-0">
                <img 
                  src="{{ image | image_url: width: 80, height: 80, crop: 'center' }}"
                  alt="{{ author }}"
                  width="50"
                  height="50"
                  loading="lazy"
                  class="w-12 h-12 rounded-full object-cover border-2 border-gray-100"
                >
              </div>
            {% endif %}
            
            <!-- Author Info -->
            <div class="{% if show_images and image != blank %}text-left{% else %}text-center{% endif %}">
              {% if link != blank %}
                <a 
                  href="{{ link | url_param_escape }}" 
                  class="font-bold text-gray-900 hover:text-blue-600 transition-colors"
                >
                  <cite class="not-italic">{{ author }}</cite>
                </a>
              {% else %}
                <cite class="font-bold text-gray-900 not-italic">{{ author }}</cite>
              {% endif %}
              
              {% if author_title != blank %}
                <p class="text-sm text-gray-500 mt-1">{{ author_title }}</p>
              {% endif %}
            </div>
            
          </figcaption>
          
        </figure>
      {% endfor %}
      
    </div>
    
    <!-- Optional CTA Button -->
    {% if section.settings.button_label != blank %}
      <div class="mt-10">
        <a 
          href="{{ section.settings.button_link | url_param_escape | default: '#' }}"
          class="inline-block px-8 py-3 bg-gray-900 text-white font-semibold rounded-lg hover:bg-gray-700 transition-colors duration-300"
        >
          {{ section.settings.button_label | escape }}
        </a>
      </div>
    {% endif %}
    
  </section>
{% endif %}

{% schema %}
{
  "name": "Testimonials",
  "tag": "section",
  "class": "testimonials-section",
  "limit": 1,
  "settings": [
    {
      "type": "header",
      "content": "Content"
    },
    {
      "type": "text",
      "id": "heading",
      "label": "Heading",
      "default": "What Our Customers Say"
    },
    {
      "type": "header",
      "content": "Layout"
    },
    {
      "type": "range",
      "id": "columns_desktop",
      "label": "Columns on desktop",
      "min": 1,
      "max": 4,
      "step": 1,
      "default": 3
    },
    {
      "type": "checkbox",
      "id": "show_images",
      "label": "Show author images",
      "default": true
    },
    {
      "type": "checkbox",
      "id": "show_ratings",
      "label": "Show star ratings",
      "default": true
    },
    {
      "type": "header",
      "content": "Style"
    },
    {
      "type": "select",
      "id": "color_scheme",
      "label": "Background color",
      "options": [
        { "value": "white", "label": "White" },
        { "value": "gray-50", "label": "Light Gray" },
        { "value": "gray-100", "label": "Gray" },
        { "value": "blue-50", "label": "Light Blue" }
      ],
      "default": "gray-50"
    },
    {
      "type": "header",
      "content": "Call to Action"
    },
    {
      "type": "text",
      "id": "button_label",
      "label": "Button label",
      "info": "Leave blank to hide button"
    },
    {
      "type": "url",
      "id": "button_link",
      "label": "Button link"
    }
  ],
  "blocks": [
    {
      "type": "testimonial",
      "name": "Testimonial",
      "limit": 12,
      "settings": [
        {
          "type": "range",
          "id": "rating",
          "label": "Star rating",
          "min": 1,
          "max": 5,
          "step": 1,
          "default": 5
        },
        {
          "type": "textarea",
          "id": "quote",
          "label": "Quote",
          "default": "This product exceeded my expectations! Amazing quality and fast shipping. Highly recommended."
        },
        {
          "type": "image_picker",
          "id": "image",
          "label": "Author image"
        },
        {
          "type": "text",
          "id": "author",
          "label": "Author name",
          "default": "Sarah Johnson"
        },
        {
          "type": "text",
          "id": "author_title",
          "label": "Author title",
          "default": "Verified Buyer",
          "info": "Optional: e.g., 'CEO at Company' or 'Verified Buyer'"
        },
        {
          "type": "url",
          "id": "link",
          "label": "Author link",
          "info": "Optional: Link to full review or author profile"
        }
      ]
    }
  ],
  "presets": [
    {
      "name": "Testimonials",
      "blocks": [
        {
          "type": "testimonial",
          "settings": {
            "quote": "Absolutely love this store! The products are top-notch and customer service is exceptional.",
            "author": "Sarah Johnson",
            "author_title": "Verified Buyer",
            "rating": 5
          }
        },
        {
          "type": "testimonial",
          "settings": {
            "quote": "Fast shipping and exactly as described. Will definitely order again!",
            "author": "Michael Chen",
            "author_title": "Repeat Customer",
            "rating": 5
          }
        },
        {
          "type": "testimonial",
          "settings": {
            "quote": "Great quality products at reasonable prices. Highly recommend to everyone!",
            "author": "Emily Davis",
            "author_title": "Happy Customer",
            "rating": 4
          }
        }
      ]
    }
  ]
}
{% endschema %}